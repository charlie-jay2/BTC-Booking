<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SIX the Musical - Booking</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .seat {
        width: 50px;
        height: 50px;
        margin: 5px;
        border-radius: 5px;
        background-color: #ddd;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 14px;
        
      }

      .seat.selected {
        background-color: green;
        color: white;
      }

      .seat.disabled {
        pointer-events: none;
        opacity: 0.5;
        background-color: #aaa !important;
        cursor: not-allowed;
      }

      .seat-gap {
        margin-left: 70px; /* Gap between E3 and E4 */
      }

      #booking-form {
        max-width: 400px;
        margin: 0 auto;
      }
    </style>
  </head>
  <body class="container mt-5 text-center">
    <h2 class="mb-4">SIX the Musical - Booking</h2>
    <h2 class="mb-4">April 20th, 2025</h2>

    <div id="seat-map" class="mb-4 d-flex flex-column align-items-center">
      <!-- Seat map generated by JS -->
    </div>

    <form id="booking-form">
      <div class="mb-3">
        <label class="form-label">Selected Seat</label>
        <input type="hidden" name="show" value="SIX the Musical" />
        <input type="hidden" name="date" value="15th April 2025" />
        <input type="hidden" name="time" value="7PM GMT" />
        <input
          type="text"
          class="form-control"
          id="seat"
          name="seat"
          readonly
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Roblox Username</label>
        <input
          type="text"
          class="form-control"
          name="robloxUsername"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Discord Username</label>
        <input
          type="text"
          class="form-control"
          name="discordUsername"
          required
        />
      </div>
      <div class="mb-3">
        <label class="form-label">Email</label>
        <input
          type="email"
          class="form-control"
          name="email"
          required
        />
      </div>
      <button type="submit" class="btn btn-primary">Book Seat</button>
    </form>

    <script>
      const seats = [
        "A1", "A2", "A3", "A4", "A5", "A6", "A7", "A8", "A9",
        "B1", "B2", "B3", "B4", "B5", "B6", "B7", "B8", "B9",
        "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9",
        "D1", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9",
        "E1", "E2", "E3", "E4", "E5", "E6"
      ];

      const seatMapDiv = document.getElementById("seat-map");
      const seatInput = document.getElementById("seat");
      let bookedSeats = [];

      async function fetchBookedSeats() {
        try {
          const res = await fetch("https://btc-booking.onrender.com/booked-seats");
          const data = await res.json();
          bookedSeats = data.bookedSeats || [];
          renderSeats();
        } catch (err) {
          console.error("Failed to fetch booked seats", err);
        }
      }

      function renderSeats() {
        seatMapDiv.innerHTML = ""; // Clear previous seat map

        const rows = {};
        seats.forEach(seat => {
          const rowLetter = seat[0];
          if (!rows[rowLetter]) rows[rowLetter] = [];
          rows[rowLetter].push(seat);
        });

        const sortedRowLetters = Object.keys(rows).sort().reverse();

        sortedRowLetters.forEach(row => {
          const rowDiv = document.createElement("div");
          rowDiv.className = "mb-2 d-flex justify-content-center flex-wrap";

          rows[row].forEach(seat => {
            const div = document.createElement("div");
            div.textContent = seat;
            div.className = "seat";

            if (bookedSeats.includes(seat)) {
              div.classList.add("disabled");
            } else {
              div.onclick = () => {
                document.querySelectorAll(".seat").forEach(el => el.classList.remove("selected"));
                div.classList.add("selected");
                seatInput.value = seat;
              };
            }

            if (seat === "E4") div.classList.add("seat-gap");

            rowDiv.appendChild(div);
          });

          seatMapDiv.appendChild(rowDiv);
        });
      }

      document.getElementById("booking-form").onsubmit = async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        try {
          const res = await fetch("https://btc-booking.onrender.com/book", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data)
          });

          const result = await res.json();
          alert(result.message || "Booking complete!");

          if (res.ok) {
            e.target.reset();
            seatInput.value = "";
            await fetchBookedSeats(); // Re-render seat map with new booked seat
          }
        } catch (err) {
          alert("Failed to submit booking.");
          console.error(err);
        }
      };

      // Initial seat map rendering
      fetchBookedSeats();
    </script>
  </body>
</html>
